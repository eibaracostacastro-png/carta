<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Carta Licencias D1, D2, D3 - Acosta Transporte y Maquinaria Pesada A&D</title>

  <style>
    :root{
      --oro:#C9A227;
      --gris:#f2f2f2;
    }

    body{
      font-family:"Times New Roman",serif;
      background: var(--gris);
      margin:0;
      padding:20px;
    }
    .contenedor{max-width:980px;margin:0 auto;}
    h1{text-align:center;margin:0 0 12px 0;}

    .formulario{
      background:#fff;
      padding:14px 18px;
      border-radius:10px;
      box-shadow:0 0 6px rgba(0,0,0,.10);
      margin-bottom:14px;
      font-size:14px;
    }
    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px 12px;
    }
    .form-group{margin:0;}
    label{display:block;font-weight:bold;margin-bottom:4px;}
    input,select{
      width:100%;
      padding:6px 9px;
      font-size:14px;
      box-sizing:border-box;
    }
    .radios{
      margin-top:8px;
      display:flex;
      gap:18px;
      align-items:center;
      flex-wrap:wrap;
    }
    .radios label{font-weight:normal;margin:0;}
    .radios input{width:auto;margin-right:6px;}

    button{
      padding:8px 14px;
      font-size:14px;
      cursor:pointer;
      border-radius:8px;
      border:1px solid #333;
      background:#fff;
      margin-right:6px;
      margin-top:10px;
    }
    button:hover{background:#f6f6f6;}

    .carta-wrapper{display:flex;justify-content:center;}
    .carta{
      position:relative;
      width:100%;
      max-width:720px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 0 10px rgba(0,0,0,.13);
      padding:22px 34px;
      font-size:13px;
      line-height:1.15;
      overflow:hidden;
    }

    /* ===== Fondo elegante (opcional) ===== */
    .carta.fondo::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 20% 10%, rgba(201,162,39,0.10), transparent 35%),
        radial-gradient(circle at 80% 30%, rgba(0,60,255,0.05), transparent 35%),
        linear-gradient(180deg, rgba(0,0,0,0.02), transparent 55%);
      pointer-events:none;
      z-index:0;
    }

    /* ===== Watermark suave ===== */
    .carta.watermark::after{
      content:attr(data-watermark);
      position:absolute;
      left:50%;
      top:55%;
      transform:translate(-50%,-50%) rotate(-18deg);
      font-size:54px;
      font-weight:700;
      letter-spacing:2px;
      color:rgba(0,0,0,0.05);
      white-space:nowrap;
      pointer-events:none;
      z-index:0;
    }

    .contenido{
      position:relative;
      z-index:1;
    }

    /* ===== Encabezado pro ===== */
    .encabezado{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:14px;
      margin-bottom:10px;
      padding-bottom:10px;
      border-bottom:2px solid var(--oro); /* línea dorada */
    }
    .logo{
      width:160px;
      max-height:90px;
      object-fit:contain;
      display:block;
    }
    .empresa{
      text-align:right;
      font-size:12px;
      line-height:1.15;
    }
    .empresa b{font-size:13px;}

    /* ===== Bloque QR + sello ===== */
    .meta{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
      margin:10px 0 8px 0;
    }
    .qr-box{
      width:120px;
      border:1px solid rgba(0,0,0,.15);
      border-radius:10px;
      padding:8px;
      text-align:center;
      background:rgba(255,255,255,0.75);
    }
    #qr{
      width:100px;height:100px;
      margin:0 auto;
    }
    .qr-box .mini{
      font-size:10px;
      line-height:1.1;
      margin-top:6px;
      color:#333;
    }

    .sello{
      flex:1;
      border:1px dashed rgba(0,0,0,.25);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(255,255,255,0.70);
    }
    .sello .titulo{
      font-weight:700;
      color:#000;
      letter-spacing:.6px;
      font-size:12px;
      text-transform:uppercase;
      margin-bottom:6px;
    }
    .sello .texto{
      font-size:11px;
      line-height:1.15;
    }

    .acciones{
      margin-top:10px;
      text-align:right;
    }

    @page{
      size:A4;
      margin:2cm;
    }

    @media print{
      body{background:#fff;margin:0;padding:0;}
      .formulario,h1,.acciones{display:none;}
      .contenedor{max-width:none;margin:0;padding:0;}
      .carta{
        max-width:none;
        border-radius:0;
        box-shadow:none;
        padding:0;
      }
      /* Si querés que el fondo NO salga impreso */
      .carta.fondo::before{display:none;}
    }
  </style>
</head>

<body>
  <div class="contenedor">
    <h1>Cartas para licencias D1 · D2 · D3</h1>

    <div class="formulario">
      <div class="form-grid">
        <div class="form-group">
          <label for="sedeCiudad">Ciudad de la sede regional:</label>
          <input type="text" id="sedeCiudad" placeholder="Ej.: Guápiles, Limón, Alajuela">
        </div>

        <div class="form-group">
          <label for="tipoLicencia">Tipo de licencia a solicitar:</label>
          <select id="tipoLicencia">
            <option value="D1">D1 - Tractor de llanta</option>
            <option value="D2">D2 - Tractor de oruga</option>
            <option value="D3" selected>D3 - Montacargas / equipo especial</option>
          </select>
        </div>

        <div class="form-group">
          <label for="nombreTrabajador">Nombre completo del trabajador / participante:</label>
          <input type="text" id="nombreTrabajador" placeholder="Nombre de la persona">
        </div>

        <div class="form-group">
          <label for="cedulaTrabajador">Cédula:</label>
          <input type="text" id="cedulaTrabajador" placeholder="0-0000-0000">
        </div>

        <div class="form-group">
          <label for="vecino">Lugar de vecindad / dirección:</label>
          <input type="text" id="vecino" placeholder="Ej.: Guápiles, Pococí, Limón, 250 m sur de...">
        </div>

        <div class="form-group">
          <label for="correo">Correo electrónico:</label>
          <input type="email" id="correo" placeholder="correo@ejemplo.com">
        </div>

        <div class="form-group">
          <label for="telefono">Teléfono:</label>
          <input type="text" id="telefono" placeholder="0000-0000">
        </div>

        <div class="form-group">
          <label for="mostrarOpciones">Opciones PRO:</label>
          <select id="mostrarOpciones">
            <option value="todo" selected>Fondo + Watermark + QR + Sello</option>
            <option value="sobrio">Sin fondo (solo watermark + QR + sello)</option>
            <option value="minimo">Solo QR (sin watermark/sello/fondo)</option>
            <option value="limpio">Limpia (sin fondo / sin QR / sin watermark / sin sello)</option>
          </select>
        </div>
      </div>

      <div class="radios">
        <span style="font-weight:bold;">Modo de carta:</span>
        <label><input type="radio" name="modoResp" value="con" checked> Con responsabilidad patronal</label>
        <label><input type="radio" name="modoResp" value="sin"> Sin responsabilidad patronal</label>
      </div>

      <button type="button" onclick="generarCarta()">Generar carta</button>
      <button type="button" onclick="copiarTexto()">Copiar texto plano</button>
      <button type="button" onclick="descargarPDF()">Descargar PDF (multipágina)</button>
      <button type="button" onclick="descargarWord()">Descargar Word</button>
    </div>

    <div class="carta-wrapper">
      <div id="carta" class="carta fondo watermark" data-watermark="">
        <div class="contenido" id="cartaContenido"></div>
      </div>
    </div>

    <div class="acciones">
      <button type="button" onclick="window.print()">Imprimir / Guardar como PDF</button>
      <button type="button" onclick="abrirVistaLimpia()">Vista limpia</button>
    </div>
  </div>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    const MESES = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
    const DIAS  = ["domingo","lunes","martes","miércoles","jueves","viernes","sábado"];

    // === Datos fijos ===
    const JEFE_NOMBRE   = "Neal Ariel Acosta Castro";
    const JEFE_CEDULA   = "702620124"; // ✅ cédula física
    const EMPRESA_NOMBRE= "Acosta Transporte y Maquinaria Pesada A&D";
    const EMPRESA_LUGAR = "Guápiles, Pococí, Limón";
    const EMPRESA_TEL   = "8977-5801";
    const LOGO_SRC      = "logoA&D.jpg"; // ✅ tu logo
    const CARGO_TITULO  = "Jefe"; // ✅ cambio solicitado

    function formatearFecha(fecha){
      return `${DIAS[fecha.getDay()]} ${fecha.getDate()} de ${MESES[fecha.getMonth()]} de ${fecha.getFullYear()}`;
    }
    function formatearFechaConDia(fecha){
      return `${DIAS[fecha.getDay()]} ${fecha.getDate()} de ${MESES[fecha.getMonth()]} del ${fecha.getFullYear()}`;
    }
    function ajustarFechaHabil(fecha){
      const f = new Date(fecha);
      if (f.getDay() === 6) f.setDate(f.getDate() - 1);
      if (f.getDay() === 0) f.setDate(f.getDate() - 2);
      return f;
    }
    function generarFechaInicioTrabajo(base){
      const f = new Date(base);
      f.setMonth(f.getMonth() - 1);
      f.setDate(f.getDate() - (3 + Math.floor(Math.random() * 3)));
      return f;
    }
    function tipoMaquinariaFrase(tipo){
      if (tipo === "D1") return "tractor de llanta, maquinaria especial agrícola autorizada para la licencia tipo D1";
      if (tipo === "D2") return "tractor de oruga, maquinaria especial de construcción autorizada para la licencia tipo D2";
      return "montacargas y equipo especial de carga (maquinaria de trabajo autorizada para la licencia tipo D3)";
    }
    function nombreMaquinariaCorto(tipo){
      if (tipo === "D1") return "tractor de llanta";
      if (tipo === "D2") return "tractor de oruga";
      return "montacargas";
    }
    function obtenerModoResponsabilidad(){
      const radios = document.getElementsByName("modoResp");
      for (const r of radios) if (r.checked) return r.value;
      return "con";
    }

    function aplicarModoVisual(){
      const modo = document.getElementById("mostrarOpciones").value;
      const carta = document.getElementById("carta");

      carta.classList.remove("fondo","watermark");

      if (modo === "todo"){
        carta.classList.add("fondo","watermark");
      } else if (modo === "sobrio"){
        carta.classList.add("watermark");
      } else if (modo === "minimo"){
        // sin fondo, sin watermark
      } else if (modo === "limpio"){
        // totalmente limpio
      }
    }

    function buildEncabezado(){
      return `
        <div class="encabezado">
          <img class="logo" src="${LOGO_SRC}" alt="Logo" onerror="this.style.display='none'">
          <div class="empresa">
            <b>${EMPRESA_NOMBRE}</b><br>
            Cédula física: <b>${JEFE_CEDULA}</b><br>
            Tel.: <b>${EMPRESA_TEL}</b>
          </div>
        </div>
      `;
    }

    function buildMetaQRySello(qrText, hoy, tipo){
      return `
        <div class="meta">
          <div class="qr-box">
            <div id="qr"></div>
            <div class="mini">
              Verificación rápida<br>
              ${hoy.getDate()}/${hoy.getMonth()+1}/${hoy.getFullYear()} · ${tipo}
            </div>
          </div>

          <div class="sello">
            <div class="titulo">Sello Digital / Constancia</div>
            <div class="texto">
              Documento emitido por <b>${EMPRESA_NOMBRE}</b> a solicitud del interesado, para trámite ante Educación Vial (MOPT).<br>
              Firmante: <b>${JEFE_NOMBRE}</b> · Cédula: <b>${JEFE_CEDULA}</b>.<br>
              Código/QR contiene los datos básicos de esta certificación.
            </div>
          </div>
        </div>
      `;
    }

    function buildSoloQR(){
      return `
        <div class="meta">
          <div class="qr-box">
            <div id="qr"></div>
            <div class="mini">Verificación rápida</div>
          </div>
        </div>
      `;
    }

    function generarCarta(){
      aplicarModoVisual();

      const sedeCiudad = document.getElementById("sedeCiudad").value.trim() || "Guápiles";
      const nombre     = document.getElementById("nombreTrabajador").value.trim() || "_____________________________";
      const cedula     = document.getElementById("cedulaTrabajador").value.trim() || "___________";
      const vecino     = document.getElementById("vecino").value.trim() || "_______________________";
      const correo     = document.getElementById("correo").value.trim() || "_______________________";
      const telefono   = document.getElementById("telefono").value.trim() || "___________";
      const tipo       = document.getElementById("tipoLicencia").value;
      const modoResp   = obtenerModoResponsabilidad();

      const hoy = ajustarFechaHabil(new Date());
      const fechaInicio = generarFechaInicioTrabajo(hoy);

      const fechaCartaLinea = formatearFecha(hoy);
      const fechaInicioTexto= formatearFechaConDia(fechaInicio);
      const sedeLinea       = `Sede Regional de Educación Vial ${sedeCiudad}`;
      const maquinariaFrase = tipoMaquinariaFrase(tipo);
      const maquinariaCorta = nombreMaquinariaCorto(tipo);

      const modoVisual = document.getElementById("mostrarOpciones").value;

      // Watermark SOLO si no es limpio
      if (modoVisual === "limpio"){
        document.getElementById("carta").setAttribute("data-watermark", "");
      } else {
        document.getElementById("carta").setAttribute("data-watermark", EMPRESA_NOMBRE.toUpperCase());
      }

      // QR data (texto)
      const qrText =
`EMPRESA: ${EMPRESA_NOMBRE}
JEFE: ${JEFE_NOMBRE} - ${JEFE_CEDULA}
TRABAJADOR/PART.: ${nombre} - ${cedula}
LICENCIA: ${tipo} (${maquinariaCorta})
SEDE: ${sedeCiudad}
FECHA CARTA: ${fechaCartaLinea}
CONTACTO: ${EMPRESA_TEL}`;

      let cuerpo = "";

      if (modoResp === "con"){
        cuerpo = `
          <b>${fechaCartaLinea}</b><br><br>

          <b>Señores:</b><br>
          <b>${sedeLinea}</b><br>
          <b>Departamento de Evaluación de Conductores</b><br>
          <b>Dirección General de Educación Vial</b><br>
          <b>Ministerio de Obras Públicas y Transportes (MOPT)</b><br><br>

          <b>Estimados señores:</b><br>
          Por medio de la presente, yo, <b>${JEFE_NOMBRE}</b>, cédula de identidad <b>${JEFE_CEDULA}</b>, en mi condición de <b>${CARGO_TITULO}</b> de <b>${EMPRESA_NOMBRE}</b>, hago constar que el señor <b>${nombre}</b>, cédula de identidad <b>${cedula}</b>, vecino de <b>${vecino}</b>, correo electrónico <b>${correo}</b> y teléfono <b>${telefono}</b>, trabaja para esta empresa desde el día <b>${fechaInicioTexto}</b>, desempeñándose como operador de <b>${maquinariaFrase}</b>.<br><br>

          Certifico que el señor <b>${nombre}</b> opera <b>${maquinariaCorta}</b> y cuenta con experiencia en el manejo de dicha maquinaria, ejecutando sus labores de forma responsable, segura y competente.<br><br>

          Por lo anterior, solicito de la manera más atenta continuar con el trámite correspondiente para la confección de la licencia tipo <b>${tipo}</b>, para la operación de <b>${maquinariaCorta}</b> indicada en la presente certificación.<br><br>

          Agradezco de antemano la atención prestada a esta solicitud.<br><br>

          Se extiende la presente en <b>${EMPRESA_LUGAR}</b>, a los <b>${hoy.getDate()}</b> días del mes de <b>${MESES[hoy.getMonth()]}</b> del año <b>${hoy.getFullYear()}</b>.<br><br>

          Atentamente,<br><br>
          ___________________________<br>
          <b>${JEFE_NOMBRE}</b><br>
          <b>${CARGO_TITULO}</b><br>
          <b>${EMPRESA_NOMBRE}</b><br>
          Cédula: <b>${JEFE_CEDULA}</b><br>
          Tel.: <b>${EMPRESA_TEL}</b>
        `;
      } else {
        cuerpo = `
          <b>${fechaCartaLinea}</b><br><br>

          <b>Señores:</b><br>
          <b>${sedeLinea}</b><br>
          <b>Departamento de Evaluación de Conductores</b><br>
          <b>Dirección General de Educación Vial</b><br>
          <b>Ministerio de Obras Públicas y Transportes (MOPT)</b><br><br>

          <b>Estimados señores:</b><br>
          Por medio de la presente, yo, <b>${JEFE_NOMBRE}</b>, cédula de identidad <b>${JEFE_CEDULA}</b>, en mi calidad de <b>${CARGO_TITULO}</b> de <b>${EMPRESA_NOMBRE}</b>, hago constar que el señor <b>${nombre}</b>, cédula de identidad <b>${cedula}</b>, vecino de <b>${vecino}</b>, correo electrónico <b>${correo}</b> y teléfono <b>${telefono}</b>, ha participado en <b>prácticas operativas supervisadas</b> relacionadas con la manipulación y operación de <b>${maquinariaFrase}</b>, en fechas comprendidas desde el día <b>${fechaInicioTexto}</b>.<br><br>

          Durante este período, el señor <b>${nombre}</b> ha demostrado responsabilidad, disciplina y habilidades suficientes para desempeñarse de manera segura en las operaciones prácticas del equipo indicado.<br><br>

          La presente constancia se emite únicamente para fines de <b>certificación de experiencia operativa</b> ante la Dirección General de Educación Vial, para la tramitación de la licencia tipo <b>${tipo}</b>.<br><br>

          <b>Esta certificación es de carácter exclusivamente formativo y no constituye relación laboral, vínculo contractual, subordinación, remuneración, ni genera derechos laborales de ningún tipo para el participante.</b><br><br>

          Agradezco de antemano la atención prestada a la presente.<br><br>

          Se extiende la presente en <b>${EMPRESA_LUGAR}</b>, a los <b>${hoy.getDate()}</b> días del mes de <b>${MESES[hoy.getMonth()]}</b> del año <b>${hoy.getFullYear()}</b>.<br><br>

          Atentamente,<br><br>
          ___________________________<br>
          <b>${JEFE_NOMBRE}</b><br>
          <b>${CARGO_TITULO}</b><br>
          <b>${EMPRESA_NOMBRE}</b><br>
          Cédula: <b>${JEFE_CEDULA}</b><br>
          Tel.: <b>${EMPRESA_TEL}</b>
        `;
      }

      // Meta según modo:
      let meta = "";
      if (modoVisual === "todo" || modoVisual === "sobrio") {
        meta = buildMetaQRySello(qrText, hoy, tipo);
      } else if (modoVisual === "minimo") {
        meta = buildSoloQR();
      } else if (modoVisual === "limpio") {
        meta = "";
      }

      const htmlFinal = `
        ${buildEncabezado()}
        ${meta}
        ${cuerpo}
      `;

      document.getElementById("cartaContenido").innerHTML = htmlFinal;

      // Render QR SOLO si existe el contenedor #qr
      const qrDiv = document.getElementById("qr");
      if (qrDiv) {
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, {
          text: qrText,
          width: 100,
          height: 100,
          correctLevel: QRCode.CorrectLevel.M
        });
      }
    }

    function copiarTexto(){
      const txt = document.getElementById("carta").innerText;
      if (!txt.trim()) return;
      navigator.clipboard.writeText(txt)
        .then(()=>alert("Texto copiado."))
        .catch(()=>alert("No se pudo copiar automáticamente."));
    }

    function abrirVistaLimpia(){
      const cartaHTML = document.getElementById("carta").innerHTML;
      const win = window.open("", "_blank");
      win.document.write(`<!DOCTYPE html><html lang="es"><head>
        <meta charset="UTF-8"><title>Carta - Vista limpia</title>
        <style>
          body{font-family:"Times New Roman",serif;margin:40px;font-size:13px;line-height:1.15;}
        </style>
      </head><body>${cartaHTML}</body></html>`);
      win.document.close();
    }

    function descargarPDF(){
      const carta = document.getElementById("carta");
      const opt = {
        margin: [10, 10, 10, 10],
        filename: "Carta_Licencia_D_A&D.pdf",
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
        pagebreak: { mode: ["css", "legacy"] }
      };
      html2pdf().set(opt).from(carta).save();
    }

    function descargarWord(){
      const cartaHTML = document.getElementById("carta").innerHTML;
      const contenido = `
<html xmlns:o='urn:schemas-microsoft-com:office:office'
      xmlns:w='urn:schemas-microsoft-com:office:word'
      xmlns='http://www.w3.org/TR/REC-html40'>
<head><meta charset="UTF-8"><title>Carta</title></head>
<body style="font-family:'Times New Roman',serif;font-size:13px;line-height:1.15;">
${cartaHTML}
</body></html>`;
      const blob = new Blob(['\ufeff', contenido], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'Carta_Licencia_D_A&D.doc';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    document.addEventListener("DOMContentLoaded", () => {
      ["sedeCiudad","nombreTrabajador","cedulaTrabajador","vecino","correo","telefono","tipoLicencia","mostrarOpciones"]
        .forEach(id => document.getElementById(id).addEventListener("input", generarCarta));
      document.getElementsByName("modoResp").forEach(r => r.addEventListener("change", generarCarta));
      generarCarta();
    });
  </script>
</body>
</html>
